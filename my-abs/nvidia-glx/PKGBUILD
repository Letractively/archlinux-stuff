# Contributor: Sergej Pupykin <ps@lx-ltd.ru>
arch=(i686 x86_64)
pkgname=nvidia-glx
pkgver=1.0.9629
_pkgver=1.0-9629
pkgrel=1
pkgdesc="nVidia OpenGL implementation for XFree86/X.Org"
url="http://www.nvidia.com"
depends=('bash' 'gcc' 'binutils' 'glibc' 'make' 'nvidia-kernel')
install=
provides=('libgl')
conflicts=('libgl')

case $CARCH in
    x86_64)
	_pkgbinary=NVIDIA-Linux-x86_64-$_pkgver
	source=(http://download.nvidia.com/XFree86/Linux-x86_64/$_pkgver/$_pkgbinary-pkg0.run)
	;;
    i686)
	_pkgbinary=NVIDIA-Linux-x86-$_pkgver
	source=(http://download.nvidia.com/XFree86/Linux-x86/$_pkgver/$_pkgbinary-pkg0.run)
                http://download.nvidia.com/XFree86/Linux-x86/1.0-8774/NVIDIA-Linux-x86-1.0-8774-pkg1.run
	;;
    *)
	exit 1
	;;
esac

build()
{
  cd $startdir/src/
  chmod +x $_pkgbinary-pkg0.run
  rm -rf ./$_pkgbinary-pkg0
  ./$_pkgbinary-pkg0.run --extract-only
  cd $_pkgbinary-pkg0
  
  mkdir -p $startdir/pkg/usr/share/applications
  mkdir -p $startdir/pkg/usr/man/man1
  mkdir -p $startdir/pkg/usr/lib/xorg/modules/{extensions,drivers}

  install -D -m0755 usr/lib/libGL.so.$pkgver $startdir/pkg/usr/lib/libGL.so.$pkgver || return 1
  ln -s libGL.so.$pkgver $startdir/pkg/usr/lib/libGL.so
  ln -s libGL.so.$pkgver $startdir/pkg/usr/lib/libGL.so.1

  install -D -m0755 usr/lib/libGLcore.so.$pkgver $startdir/pkg/usr/lib/libGLcore.so.$pkgver || return 1
  ln -s libGLcore.so.$pkgver $startdir/pkg/usr/lib/libGLcore.so.1

  install -D -m0755 usr/lib/libnvidia-cfg.so.$pkgver $startdir/pkg/usr/lib/libnvidia-cfg.so.$pkgver || return 1
  ln -s libnvidia-cfg.so.$pkgver $startdir/pkg/usr/lib/libnvidia-cfg.so.1
  ln -s libnvidia-cfg.so.$pkgver $startdir/pkg/usr/lib/libnvidia-cfg.so

  install -D -m0755 usr/lib/libnvidia-tls.so.$pkgver $startdir/pkg/usr/lib/libnvidia-tls.so.$pkgver || return 1
  ln -s libnvidia-tls.so.$pkgver $startdir/pkg/usr/lib/libnvidia-tls.so.1

  install -D -m0755 usr/X11R6/lib/libXvMCNVIDIA.a $startdir/pkg/usr/lib/libXvMCNVIDIA.a || return 1
  install -D -m0755 usr/X11R6/lib/libXvMCNVIDIA.so.$pkgver $startdir/pkg/usr/lib/libXvMCNVIDIA.so.$pkgver || return 1
  ln -s libXvMCNVIDIA.so.$pkgver $startdir/pkg/usr/lib/libXvMCNVIDIA_dynamic.so.1

#  install -D -m0755 usr/X11R6/lib/modules/drivers/nvidia_drv.o $startdir/pkg/usr/lib/xorg/modules/drivers/nvidia_drv.o || return 1
  install -D -m0755 usr/X11R6/lib/modules/drivers/nvidia_drv.so $startdir/pkg/usr/lib/xorg/modules/drivers/nvidia_drv.so || return 1
  install -D -m0755 usr/X11R6/lib/modules/extensions/libglx.so.$pkgver $startdir/pkg/usr/lib/xorg/modules/extensions/libglx.so.$pkgver || return 1
  ln -s libglx.so.$pkgver $startdir/pkg/usr/lib/xorg/modules/extensions/libglx.so

  install -D -m0644 usr/share/applications/nvidia-settings.desktop $startdir/pkg/usr/share/applications/nvidia-settings.desktop || return 1
  install -D -m0644 usr/share/man/man1/nvidia-settings.1.gz $startdir/pkg/usr/man/man1/nvidia-settings.1.gz || return 1
  install -D -m0644 usr/share/man/man1/nvidia-xconfig.1.gz $startdir/pkg/usr/man/man1/nvidia-xconfig.1.gz || return 1

  install -D -m0755 usr/bin/nvidia-settings $startdir/pkg/usr/bin/nvidia-settings || return 1
  install -D -m0755 usr/bin/nvidia-xconfig $startdir/pkg/usr/bin/nvidia-xconfig || return 1
  install -D -m0644 usr/share/pixmaps/nvidia-settings.png $startdir/pkg/usr/share/icons/hicolor/48x48/apps/nvidia-settings.png
}
