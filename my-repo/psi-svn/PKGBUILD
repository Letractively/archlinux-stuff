# Contributor: slubman <slubman.dndd@slubman.info>

pkgname=psi-svn
pkgver=1168
pkgrel=1
pkgdesc="A jabber client SVN version"
arch=('i686' 'x86_64')
makedepends=('subversion')
depends=('qt' 'aspell' 'libxss')
source=(psi-icon-actions-shortcuts.patch)
conflicts=('psi')
provides=('psi')
license=('custom')
url="http://psi-im.org/"

_svntrunk="http://svn.psi-im.org/psi/trunk"
_svnmod="psi"

build() {
	cd $startdir/src

	# get the sources
	msg "Connecting to $_svntrunk ..."
	if [ -d $_svnmod/.svn ]; then
		(cd $_svnmod && svn up -r $pkgver) || return 1
	else
		svn co $_svntrunk --config-dir ./ -r $pkgver $_svnmod || return 1
	fi
	msg "SVN checkout done or server timeout"

	if [ -d ${_svnmod}-build ]; then
		msg "Deleting old build directory"
		rm -rf ${_svnmod}-build
	fi
	cp -r ${_svnmod} ${_svnmod}-build
	cd ${_svnmod}-build

	# building
	msg "Starting build"

	patch -p1 <../psi-icon-actions-shortcuts.patch

	./configure --prefix=/usr || return 1
	make || return 1
	make INSTALL_ROOT=$startdir/pkg install || return 1

	# Copy Psi license
	install -D COPYING $startdir/pkg/usr/share/licenses/$pkgname/COPYING

	# Remove all those stupdid svn related files installed
	find $startdir/pkg -type d -name '.svn' | xargs rm -rf
}
