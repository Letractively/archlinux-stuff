# Contributor: Nicktian Lezver <nicktian@mailru>
pkgname="psi+"
pkgver=645
pkgrel=1
pkgdesc="Psi Mod from psi-dev@conference.jabber.ru"
url="http://code.google.com/p/psi-dev/"
license=('GPL2')
arch=('i686' 'x86_64')
depends=('qt' 'aspell' 'libxss' 'openssl' 'dbus' 'zlib')
makedepends=("subversion")
conflicts=('psi-git' 'psi' 'psi-svn')
provides=('psi')

_svntrunk="http://psi-dev.googlecode.com/svn/trunk/patches"
_svnmod="patches"
_gitroot__="git://git.psi-im.org/psi.git"
_gitname__="psi"

build() {
  cd $srcdir
if false; then
  msg "Getting patches from SVN"
  msg "connecting to ${_svntrunk}"
  if [ -d $srcdir/${_svnmod} ] ; then
    svn up ${_svnmod} -r $pkgver
    msg "$srcdir/${_svnmod}"
  else
    svn checkout ${_svntrunk} $srcdir/${_svnmod}
  fi
  msg "SVN Checkout done or server timeout"

  msg "Connecting to ${_gitroot__} ..."
  if [ -d $srcdir/${_gitname__} ] ; then
    cd ${_gitname__} && git pull origin
    msg "Updating iris ..."
    git submodule update
    msg "The local files are updated."
  else
    git clone ${_gitroot__}
    cd psi
    msg "Getting iris ..."
    git submodule init
    git submodule update
  fi
  msg "GIT checkout done or server timeout"
   
  [ -d $srcdir/${_gitname__}-build ] && rm -r $srcdir/${_gitname__}-build
  cp -r $srcdir/${_gitname__} $srcdir/${_gitname__}-build

  msg "Copying patches to build directory"
  cp $srcdir/patches/* $srcdir/${_gitname__}-build/	    

  cd $srcdir/${_gitname__}-build
  msg "Applying patches"
  sh series.txt
  msg "Building $pkgname ..."

  sed -i 's|#CONFIG += whiteboarding|CONFIG += whiteboarding|' src/src.pro
  sed -i 's|#CONFIG += psi_plugins|CONFIG += psi_plugins|' src/src.pro
  ./configure --prefix=/usr
else
  cd $srcdir/${_gitname__}-build
fi
  make || return 1
  make INSTALL_ROOT="$pkgdir" install || return 1

  # Copy Psi license
  install -D COPYING "$pkgdir/usr/share/licenses/$pkgname/COPYING" || return 1
#  rm -r $srcdir/${_gitname__}-build
}
