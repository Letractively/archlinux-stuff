# Contributor: slubman <slubman.dndd@slubman.info>

pkgname=psi-git
pkgver=20090113
pkgrel=1
pkgdesc="A jabber client SVN version"
arch=('i686' 'x86_64')
makedepends=('subversion')
depends=('qt' 'aspell' 'libxss' 'speex' 'ortp' 'glib2' 'libjingle')
source=(psi-icon-actions-shortcuts.patch
	psi-jingle-build-fix.patch)
conflicts=('psi')
provides=('psi')
replaces=('psi-svn')
license=('custom')
url="http://psi-im.org/"

_gitroot="git://git.psi-im.org/psi.git"
_gitname="psi"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d ${_gitname} ] ; then
    cd ${_gitname} && git pull origin && git submodule update
    msg "The local files are updated."
  else
    git clone ${_gitroot}
    (cd ${_gitname} && git submodule init && git submodule update)
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/${_gitname}-build"
  cp -Lr "$srcdir/${_gitname}" "$srcdir/${_gitname}-build"
  cd "$srcdir/${_gitname}-build"

  # building
  msg "Starting build"

  patch -p1 <../psi-icon-actions-shortcuts.patch
  patch -p1 <../psi-jingle-build-fix.patch

  sed -i 's|#CONFIG += psi_plugins|CONFIG += psi_plugins|' src/src.pro

  ./configure-jingle --enable-jingle --prefix=/usr || return 1
  make || return 1
  make INSTALL_ROOT=$startdir/pkg install || return 1

  # Copy Psi license
  install -D COPYING $startdir/pkg/usr/share/licenses/$pkgname/COPYING || return 1

  # Remove all those stupdid svn related files installed
  find $startdir/pkg -type d -name '.svn' | xargs rm -rf
}
