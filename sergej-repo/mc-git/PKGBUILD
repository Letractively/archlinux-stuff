pkgname=mc-git
pkgver=20091001
pkgrel=1
pkgdesc="GNU Midnight Commander is a s-lang based file manager"
url="http://midnight-commander.org/"
arch=('i686' 'x86_64')
license=('GPL')
depends=('glibc' 'glib2' 'slang')
makedepends=('git' 'pkgconfig' 'automake' 'autoconf')
conflicts=('mc' 'mc-cvs' 'mc-fork-svn' 'mc-mp' 'mc-slavz' 'mc-suse')
provides=('mc')
options=(!distcc)
install=mc-git.install

_gitroot="git://midnight-commander.org/git/mc.git"
_gitname="mc"

build() {
    cd ${srcdir}

if [ $NOEXTRACT -ne 1 ]; then
    msg "Connecting to the git repository..."
    if [ -d ${srcdir}/${_gitname} ]; then
        cd ${_gitname}
        git pull origin
    else
        git clone ${_gitroot}
    fi
    msg "GIT checkout done or server timeout"

    rm -rf ${srcdir}/${_gitname}-build
    cp -Lr  ${srcdir}/${_gitname} ${srcdir}/${_gitname}-build
    cd ${srcdir}/${_gitname}-build

    patch -p0 syntax/Makefile.am <<EOF
2,61c2,65
< 	ada95.syntax		\\
< 	awk.syntax		\\
< 	aspx.syntax		\\
< 	assembler.syntax	\\
< 	c.syntax		\\
< 	changelog.syntax	\\
< 	debian-changelog.syntax	\\
< 	debian-control.syntax	\\
< 	debian-description.syntax \\
< 	debian-sources-list.syntax \\
< 	cs.syntax		\\
< 	css.syntax		\\
< 	cxx.syntax		\\
< 	d.syntax		\\
< 	diff.syntax		\\
< 	dos.syntax		\\
< 	ebuild.syntax		\\
< 	eiffel.syntax		\\
< 	erlang.syntax		\\
< 	f90.syntax		\\
< 	fortran.syntax		\\
< 	haskell.syntax		\\
< 	html.syntax		\\
< 	idl.syntax		\\
< 	java.syntax		\\
< 	js.syntax		\\
< 	latex.syntax		\\
< 	lisp.syntax		\\
< 	lsm.syntax		\\
< 	lua.syntax		\\
< 	nemerle.syntax		\\
< 	m4.syntax		\\
< 	mail.syntax		\\
< 	makefile.syntax		\\
< 	ml.syntax		\\
< 	named.syntax    	\\
< 	nroff.syntax		\\
< 	octave.syntax		\\
< 	pascal.syntax		\\
< 	perl.syntax		\\
< 	php.syntax		\\
< 	po.syntax		\\
< 	povray.syntax		\\
< 	procmail.syntax		\\
< 	python.syntax		\\
< 	ruby.syntax		\\
< 	sh.syntax		\\
< 	smalltalk.syntax	\\
< 	slang.syntax		\\
< 	spec.syntax		\\
< 	strace.syntax 		\\
< 	sql.syntax		\\
< 	swig.syntax		\\
< 	syntax.syntax		\\
< 	tcl.syntax		\\
< 	texinfo.syntax		\\
< 	verilog.syntax		\\
< 	vhdl.syntax		\\
< 	unknown.syntax		\\
< 	xml.syntax
---
>         ada95.syntax \\
>         aspx.syntax \\
>         assembler.syntax \\
>         awk.syntax \\
>         changelog.syntax \\
>         css.syntax \\
>         cs.syntax \\
>         c.syntax \\
>         cxx.syntax \\
>         debian-changelog.syntax \\
>         debian-control.syntax \\
>         debian-description.syntax \\
>         debian-sources-list.syntax \\
>         diff.syntax \\
>         dos.syntax \\
>         d.syntax \\
>         ebuild.syntax \\
>         eiffel.syntax \\
>         erlang.syntax \\
>         f90.syntax \\
>         fortran.syntax \\
>         haskell.syntax \\
>         html.syntax \\
>         idl.syntax \\
>         java.syntax \\
>         js.syntax \\
>         j.syntax \\
>         latex.syntax \\
>         lisp.syntax \\
>         lsm.syntax \\
>         lua.syntax \\
>         m4.syntax \\
>         mail.syntax \\
>         makefile.syntax \\
>         ml.syntax \\
>         named.syntax \\
>         nemerle.syntax \\
>         nroff.syntax \\
>         octave.syntax \\
>         pascal.syntax \\
>         perl.syntax \\
>         php.syntax \\
>         PKGBUILD.syntax \\
>         po.syntax \\
>         povray.syntax \\
>         procmail.syntax \\
>         python.syntax \\
>         ruby.syntax \\
>         sh.syntax \\
>         slang.syntax \\
>         smalltalk.syntax \\
>         spec.syntax \\
>         sql.syntax \\
>         strace.syntax \\
>         swig.syntax \\
>         syntax.syntax \\
>         tcl.syntax \\
>         texinfo.syntax \\
>         tt.syntax \\
>         unknown.syntax \\
>         verilog.syntax \\
>         vhdl.syntax \\
>         xml.syntax \\
>         yum.repo.syntax
EOF

    ./autogen.sh

    export MCREVISION="$(git describe --tags)"

    msg "Configuring..."
    CFLAGS="-std=gnu99" ./configure                     \
        --prefix=/usr               \
        --sysconfdir=/etc           \
        --libexecdir=/usr/lib       \
        --enable-background         \
        --enable-network            \
        --enable-netcode            \
        --enable-charset            \
        --enable-nls                \
        --with-vfs                  \
        --with-edit                 \
        --with-screen=slang         \
        --with-x                 \
        --with-samba             \
        --without-gpm-mouse         \
        --without-gnome             \
        --without-debug             \
        --without-included-gettext  \
        --disable-dependency-tracking
else
    cd ${srcdir}/${_gitname}-build
fi
    msg "Starting make..."
    make || return 1
    make DESTDIR=${pkgdir} install || return 1

    rm -f $pkgdir/usr/share/mc/extfs/u7z
}
